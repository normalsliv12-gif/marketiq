rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function usernameUnchanged(docId) {
      return !('username' in request.resource.data)
          || request.resource.data.username == docId;
    }

    function onlyAllowedFields() {
      let allowedFields = [
        'rating', 'puzzlesSolved', 'accuracy', 'streak',
        'lastPlayedDate', 'lastThrillDate', 'dailyPuzzlesCompleted',
        'performance', 'recentActivity', 'passwordHash', 'passwordSalt'
      ];
      return request.resource.data.keys().hasOnly(allowedFields);
    }

    function numericFieldsValid() {
      let data = request.resource.data;
      return (!('rating' in data) || (data.rating >= 0 && data.rating <= 5000))
          && (!('accuracy' in data) || (data.accuracy >= 0 && data.accuracy <= 100))
          && (!('streak' in data) || (data.streak >= 0 && data.streak <= 1000))
          && (!('puzzlesSolved' in data) || (data.puzzlesSolved >= 0 && data.puzzlesSolved <= 100000))
          && (!('dailyPuzzlesCompleted' in data) || (data.dailyPuzzlesCompleted >= 0 && data.dailyPuzzlesCompleted <= 5));
    }

    match /users/{userId} {
      allow read: if true;
      allow create: if userId == request.resource.data.username
          && request.resource.data.username.matches('^[a-zA-Z0-9_]{3,20}$')
          && 'rating' in request.resource.data
          && 'passwordHash' in request.resource.data
          && 'passwordSalt' in request.resource.data
          && request.resource.data.rating == 1200;
      allow update: if onlyAllowedFields()
          && usernameUnchanged(userId)
          && numericFieldsValid();
      allow delete: if false;
    }

    match /userPredictions/{userId} {
      allow read: if true;
      allow create, update: if request.resource.data.size() <= 10;
      allow delete: if false;
    }

    match /predictions/{weekKey}/{questionId}/{userId} {
      allow read: if true;
      allow create, update: if
          weekKey.matches('^[0-9]{4}-W[0-9]{2}$')
          && questionId in ['q1', 'q2', 'q3']
          && request.resource.data.probability is int
          && request.resource.data.probability >= 0
          && request.resource.data.probability <= 100
          && 'timestamp' in request.resource.data
          && 'username' in request.resource.data
          && request.resource.data.username == userId
          && request.resource.data.keys().hasOnly(['probability', 'timestamp', 'username']);
      allow delete: if false;
    }

  }
}
